# Name:    PyHouse-ansible/roles/add-user/tasks/main.yaml
# Author:  D. Brian Kimmel
# Created: 2017-10-15
# Updated: 2017-12-11
#
# This role adds the admin user to the node.
# This user is in the vault of production and setup-pi under group_vars/all.
#

---

- name: Task-01 - Create pi .ssh dir
  ignore_errors:    yes
  file:
    name:       "/home/pi/.ssh"
    state:      directory
    owner:      "pi"
    group:      "pi"
    mode:       0700

- name: Task-01 - Copy authorized_keys file to ~/.ssh
  copy:
    src:        "~/.ssh/authorized_keys"
    dest:       "/home/pi/.ssh"
    owner:      "pi"
    group:      "pi"
    mode:       0600

# --- "pi" user
# Change the pi user's password
- name: Task-01-Debian - Change "pi" password
  ignore_errors:    yes
  become_user:      root
  become:           yes
  user:
    name:           pi
    password:       "{{ pyh_pi_password }}"
    comment:        "Default User"
  when: ansible_os_family == 'Debian'


- name: Task-dd - Info
  debug:
    msg: " User:{{ pyh_admin_user }};  Pass:{{ vault_pyh_admin_password }};  Dist:{{ansible_os_family}}; "



# --- "Admin" user
# Create the admin user
- name: Task-02-Suse - Add Admin User
  ignore_errors:    yes
  become_user:      root
  become:           yes
  user:
    name:           "{{ pyh_admin_user }}"
    password:       "{{ pyh_admin_password }}"
    comment:        "{{ vault_pyh_long_admin_name }}"
    shell:          /bin/bash
    groups:         "{{ pyh_admin_user_groups }}"
  when: ansible_lsb.id == 'Suse'

- name: Task-02-Raspbian - Add Admin User
  ignore_errors:    yes
  become_user:      root
  become:           yes
  user:
    name:           "{{ pyh_admin_user }}"
    password:       "{{ pyh_admin_password }}"
    comment:        "{{ vault_pyh_long_admin_name }}"
    shell:          /bin/bash
    groups:         "{{ pyh_admin_user_groups }}"
  when: ansible_lsb.id == 'Raspbian'

- name: Task-02-Ubuntu - Add Admin User
  ignore_errors:    yes
  become_user:      root
  become:           yes
  user:
    name:           "{{ pyh_admin_user }}"
    password:       "{{ pyh_admin_password }}"
    comment:        "{{ vault_pyh_long_admin_name }}"
    shell:          /bin/bash
    groups:         "{{ pyh_admin_user_groups }}"
  when: ansible_lsb.id == 'Ubuntu'

- name: Task-03 - Create the sudoers.d file for admin user
  ignore_errors:    yes
  become_user:      root
  become:           yes
  template:
    src:            ./sudoers.j2
    dest:           "/etc/sudoers.d/{{ pyh_admin_user }}"
    owner:          root
    group:          root
    mode:           0600

- name: Task-04 - Be sure admin user home dir ownership is OK
  ignore_errors:    yes
  become_user:      root
  become:           yes
  file:
    name:       "/home/{{ pyh_admin_user }}/"
    state:      directory
    owner:      "{{ pyh_admin_user }}"
    group:      "{{ pyh_admin_user }}"
    mode:       0755

- name: Task-05 - Create bin dir for admin user
  ignore_errors:    yes
  become_user:      root
  become:           yes
  file:
    name:       "/home/{{ pyh_admin_user }}/bin"
    state:      directory
    owner:      "{{ pyh_admin_user }}"
    group:      "{{ pyh_admin_user }}"
    mode:       0755

- name: Task-06 - Copy admin files to ~/bin
  ignore_errors:    yes
  become_user:      root
  become:           yes
  copy:
    src:        "../files/ModelDiscovery.sh"
    dest:       "/home/{{ pyh_admin_user }}/bin"
    owner:      "{{ pyh_admin_user }}"
    group:      "{{ pyh_admin_user }}"
    mode:       0755

- name: Task-07 - Create admin user .ssh dir
  ignore_errors:    yes
  become_user:      root
  become:           yes
  file:
    name:       "/home/{{ pyh_admin_user }}/.ssh"
    state:      directory
    owner:      "{{ pyh_admin_user }}"
    group:      "{{ pyh_admin_user }}"
    mode:       0700

- name: Task-08 - Copy authorized_keys file to ~/.ssh
  become_user:      root
  become:           yes
  copy:
    src:        "~/.ssh/authorized_keys"
    dest:       "/home/{{ pyh_admin_user }}/.ssh"
    owner:      "{{ pyh_admin_user }}"
    group:      "{{ pyh_admin_user }}"
    mode:       0600

- name: Task-09 - Copy id_rsa file to ~/.ssh
  become_user:      root
  become:           yes
  copy:
    src:        "~/.ssh/id_rsa"
    dest:       "/home/{{ pyh_admin_user }}/.ssh"
    owner:      "{{ pyh_admin_user }}"
    group:      "{{ pyh_admin_user }}"
    mode:       0600

### END DBK
