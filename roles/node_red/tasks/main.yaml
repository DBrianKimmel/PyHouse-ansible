# Name:    PyHouse-ansible/roles/node_red/tasks/main.yaml - the master playbook
# Author:  D. Brian Kimmel
# Created: 2017-10-11
# Updated: 2017-11-10
#
# Lite versions of the os do not install node-red.
# The install scripts and apt both sorta do the wrong versions so do it all manually here.

---

- name: Task-01 - Set up the proper OS distribution
  include_tasks:    "setup-{{ansible_os_family}}.yaml"

# Create the Node Red user
- name: Task-02 - Add Node Red User
  user:
    name:           "{{ pyh_nodered_user }}"
    password:       "{{ pyh_nodered_password }}"
    comment:        "Node Red User"
    shell:          /bin/bash
    groups:         "{{ pyh_nodered_user_groups }}"

- name: Task-03 - Create nodered user .ssh dir
  file:
    name:           "/home/{{ pyh_nodered_user }}/.ssh"
    state:          directory
    owner:          "{{ pyh_nodered_user }}"
    group:          "{{ pyh_nodered_user }}"
    mode:           0700

- name: Task-04 - Copy nodered authorized_keys file to ~/.ssh
  copy:
    src:            "~/.ssh/authorized_keys"
    dest:           "/home/{{ pyh_nodered_user }}/.ssh"
    owner:          "{{ pyh_nodered_user }}"
    group:          "{{ pyh_nodered_user }}"
    mode:           0600

- name: Task-05 - Copy id_rsa file to ~/.ssh
  copy:
    src:            "~/.ssh/id_rsa"
    dest:           "/home/{{ pyh_nodered_user }}/.ssh"
    owner:          "{{ pyh_nodered_user }}"
    group:          "{{ pyh_nodered_user }}"
    mode:           0600

- name: Task-06 - Install extra apt packages for node red
  import_tasks:    install-extra-packages.yaml

- name: Task-07 - Install Node.js (correct version)
  import_tasks:    install-nodejs.yaml

- name: Task-08 - Install Node-Red (correct version)
  import_tasks:    install-nodered.yaml

- name: Task-09 - Install extra node red nodes
  import_tasks:    install-extra-nodes.yaml

- name: Task-10 - Setup auto run on reboot
  include_tasks:    install-systemd.yaml

- name: Task-11 - Save the flows we have
  include_tasks:    backup-flows.yaml
  tags:             fetch-files

### END DBK
