# Name: roles/function_octoprint/tasks/setup_octo_user.yaml
# Updated: 2020-12-24

# The first step of creating an octoprint Raspbrry Pi.
# Create the user 'octo' that will run octoprint on powerup.
---

- name: Task-01(User) - Check if /home/octo exists.
  stat:
     path: "{{ octoprint_home_dir }}"
  register: stat_result_user

- name: Task-02(User) - Fresh install or not.
  set_fact:
     octoprint_initial_install: true
  when: stat_result_user.stat.exists != true


- name: Task-03(User) - Add User "octo".
  user:
    name: "{{ octoprint_user_name }}"
    comment: "{{ octoprint_user_comment }}"
    groups: "{{ octoprint_user_groups }}"
    create_home: true
    password: $6$tiuFB7p31L$G2Z/NoFyTEz18HwOsbaTPh4fM5rSq1nratdP8YhFjyR7U6xwC7KLg4GKOGaKXLOBr6TfZBTzUN63Afp11ZOan.
    state: present
  when: octoprint_initial_install

- name: Task-04(User) - Create all the user dirs we will need.
  ignore_errors:        yes
  file:
    name: "{{ item.name | default(item, true) }}"
    state:              directory
    owner:              "{{ octoprint_user_name }}"
    group:              "{{ octoprint_user_name }}"
    mode:               0750
  with_items: "{{ octoprint_additional_directories }}"

- name: Task-05(User) - Create start-octoprint command in ~/bin directory.
  template:
    src:                "start-octoprint.j2"
    dest:               "{{ octoprint_home_dir }}/bin/start-octoprint"
    owner:              '{{ octoprint_user_name }}'
    group:              '{{ octoprint_user_name }}'
    mode:               0755

- name: Task-06(User) - Create stop-octoprint command in ~/bin directory.
  template:
    src:                "stop-octoprint.j2"
    dest:               "{{ octoprint_home_dir }}/bin/stop-octoprint"
    owner:              '{{ octoprint_user_name }}'
    group:              '{{ octoprint_user_name }}'
    mode:               0755

- name: Task-07(User) - Create start-camera command in ~/bin directory.
  template:
    src:                "start-camera.j2"
    dest:               "{{ octoprint_home_dir }}/bin/start-camera"
    owner:              '{{ octoprint_user_name }}'
    group:              '{{ octoprint_user_name }}'
    mode:               0755

- name: Task-08(User) - Create sudoers file
  template:
    src:                "sudoers.j2"
    dest:               "/etc/sudoers.d/{{ octoprint_user_name }}"
    mode:               0600

### END DBK