#!/bin/bash
#
# Name:    PyHouse-ansible/roles/install-octoprint/files/bin/start-webcam
# Author:  D. Brian Kimmel
# Updated: 2020-12-21
#

MJPGSTREAMER_HOME='{{ octoprint_home_dir }}/mjpg-streamer/mjpg-streamer-experimental'
MJPGSTREAMER_INPUT_RASPICAM="input_raspicam.so"

# init configuration
camera="auto"
camera_raspi_options="-fps 10"

# runs MJPG Streamer, using the provided input plugin + configuration
function runMjpgStreamer {
    input=$1
    pushd $MJPGSTREAMER_HOME
    echo Running ./mjpg_streamer -o "output_http.so -w ./www" -i "$input"
    LD_LIBRARY_PATH=. ./mjpg_streamer -o "output_http.so -w ./www" -i "$input"
    popd
}

# starts up the RasPiCam
function startRaspi {
    logger "Starting Raspberry Pi camera"
    runMjpgStreamer "$MJPGSTREAMER_INPUT_RASPICAM $camera_raspi_options"
}

# we need this to prevent the later calls to vcgencmd from blocking.
# I have no idea why, but that's how it is...
vcgencmd version

# echo configuration
echo camera: $camera
echo raspi options: $camera_raspi_options

# keep mjpg streamer running if some camera is attached
while true; do
    if [ "`vcgencmd get_camera`" = "supported=1 detected=1" ] && { [ "$camera" = "auto" ] || [ "$camera" = "raspi" ] ; }; then
        startRaspi
    fi
    sleep 120
done

### END DBK
