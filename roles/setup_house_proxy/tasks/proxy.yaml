# Name:   roles/setup_house_proxy/tasks/proxy.yaml
# Updated: 2020-11-12
#
#---

- name: Task-01(Proxy) - Info about each computer in this play...
  debug:
    msg:
      - " Role:   tasks/setup_house_proxy.yaml"
      - " Distribution: {{ ansible_distribution }}, {{ ansible_facts.distribution }}"
      - " MajorVersion: {{ ansible_facts.distribution_major_version }}"
      - "    Os Family: {{ ansible_os_family }}"
      - "          Lsb: {{ ansible_lsb }}"

# ansible_os_family:   Debian, RedHat, Suse, Darwin, 
# ansible_lsb.id:   Raspbian, Ubuntu, Suse
#
- name: Task-02(Proxy) - set OS dependent variables.
  include_vars: '{{ item }}'
  with_first_found:
    - '{{ ansible_facts.distribution }}_{{ ansible_facts.distribution_major_version }}.yaml'
    - '{{ ansible_facts.distribution }}.yaml'
    - '{{ ansible_facts.os_family }}_{{ ansible_facts.distribution_major_version }}.yaml'
    - '{{ ansible_facts.os_family }}.yaml'

- name: Task-03(Proxy) - Install Nginx.
  include_role:
     name: install_nginx

- name: Task-04(Proxy) - Create css configuration directory.
  file:
    dest: "{{ house_main_proxy_html_dir }}/css"
    state: directory
    mode: 0755
  tags:
    - proxy-config

- name: Task-05(Proxy) - Install the CSS file (Lcars).
  copy:
    src: ./style.css
    dest: "{{ house_main_proxy_html_dir }}/css/style.css"
    owner: "{{ nginx_installed_owner }}"
    group: "{{ nginx_installed_owner }}"
    mode: 0644
  tags:
    - proxy-config
  notify:
    - restart proxy

- name: Task-06(Proxy) - Load index.html file
  template:
    src: index.html.j2
    dest: "{{ house_main_proxy_html_dir }}/index.html"
    owner: "{{ nginx_installed_owner }}"
    group: "{{ nginx_installed_owner }}"
    mode: 0644
  tags:
    - proxy-config7
  notify:
    - restart proxy

- name: Task-07(Proxy) - install proxy config file.
#  ANSIBLE_DEBUG=1
  template:
    src: proxy-main.j2
    dest: /etc/nginx/sites-available/proxy-main
    owner: root
    group: root
    mode: 0644

- name: Task-08(Proxy) - Create a symbolic link.
  file:
    src: /etc/nginx/sites-available/proxy-main
    dest: /etc/nginx/sites-enabled/01-proxy-main
    owner: root
    group: root
    state: link

- name: sites & links
  include_tasks: sites.yaml

### END DBK
