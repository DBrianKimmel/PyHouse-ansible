# Name:    PyHouse-ansible/roles/pyhouse/tasks/main.yaml
# Author:  D. Brian Kimmel
# Created: 2017-09-18
# Updated: 2017-10-26
#
# This  is to add/maintain the pyhouse system on a node computer such as a raspberry pi.
#
# called       when: pyh_roles.find("pyhouse") != -1
#
---

#- name: Task-dd
#  debug:        msg="In PyHouse-main now"

- name: Task-01 - Create PyHouse user
  user:
    name:       "{{ pyh_pyhouse_user }}"
    password:   "abc"
    shell:      /bin/bash
    comment:    "PyHouse User"
    groups:     dialout,audio,video,input

- name: Task-02 - Be sure git is installed so we can fetch the reposotory
  apt:
    name:               git
    state:              latest
    update_cache:       yes
    cache_valid_time:   3600

- name: Task-03 - Create Directory /etc/pyhouse
  file:
    name:       "/etc/pyhouse"
    state:      directory
    owner:      '{{ pyh_pyhouse_user }}'
    group:      '{{ pyh_pyhouse_user }}'
    mode:       0755

- name: Task-04 - Create Directory /var/log/pyhouse
  file:
    name:       "/var/log/pyhouse"
    state:      directory
    owner:      '{{ pyh_pyhouse_user }}'
    group:      '{{ pyh_pyhouse_user }}'
    mode:       0755

- name: Task-05 - Create Directory ~/workspace
  file:
    name:       "/home/pyhouse/workspace"
    state:      directory
    owner:      '{{ pyh_pyhouse_user }}'
    group:      '{{ pyh_pyhouse_user }}'
    mode:       0755

- name: Task-06 - Create Directory  ~/bin
  file:
    name:       "/home/pyhouse/bin"
    state:      directory
    owner:      '{{ pyh_pyhouse_user }}'
    group:      '{{ pyh_pyhouse_user }}'
    mode:       0755

- name: Task-07 - Copy files to ~/bin
  copy:
    src:        "./bin/"
    dest:       "/home/pyhouse/bin"
    owner:      '{{ pyh_pyhouse_user }}'
    group:      '{{ pyh_pyhouse_user }}'
    mode:       0755

- name: Task-08 - fetch the xml config files
  fetch:
    src:                /etc/pyhouse/master.xml
    dest:               host_files/
    fail_on_missing:    no

- name: Task-09 - Clone the PyHouse package
  git:
    repo:               https://git@github.com/DBrianKimmel/PyHouse.git
    dest:               /home/pyhouse/workspace/PyHouse
    accept_hostkey:     yes
    force:              yes
  when:                 hostvars[inventory_hostname].pyh_roles | search("pyhouse")

# todo:
# Autologin
- name: Task-10 - Autologin as pyhouse user
  lineinfile:
    path:               '/etc/systemd/system/autologin@.service'
    regexp:             '--autologin '
    line:               'ExecStart=-/sbin/agetty --autologin {{ pyh_pyhouse_user }} --noclear %I $TERM'
  when:                 hostvars[inventory_hostname].pyh_roles | search("pyhouse")

# Autostart pyhouse



### END DBK
