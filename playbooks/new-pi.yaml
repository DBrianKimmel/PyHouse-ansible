# Name:    PyHouse-ansible/playbooks/new-pi.yaml
# Author:  D. Brian Kimmel
# Created: 2017-11-17
# Updated: 2017-12-06

# This playbook is used to set up one raspberry pi computer
#
# It goes from installing a fresh version of the particular OS to being a basically functioning unit/
#
# It works for:
#   Raspbian - Stretch Lite
#
---

- name: Play - New-Pi - Set up a fresh Pi 
  hosts:            raspberrypi
  strategy:         debug
  remote_user:      root
  become:           yes
  become_method:    sudo

  pre_tasks:

    - name: New-Pi-pre-task-01 - Fail if Ansible is ancient
      fail:
        msg: "We need Ansible >= 2.4. Please update your installed ansible"
      when: ansible_version.major < 2 or ( ansible_version.major >= 2 and ansible_version.minor < 4 )
      tags:
        - always

    - name: New-Pi-pre-task-02- Include vars from local-configure.yaml if found
      include_vars: "{{ item }}"
      with_first_found:
        - files:
            - "local-configure.yaml"
            - "null.yaml"
          paths:
            - "../defaults/"
      tags:
        - always

    - name: New-Pi-pre-task-03 - Working on raspi
      debug:
        msg: "Host:{{ pyh_hostname }}; WiFi:{{ pyh_ipv4_wifi_addr }}; Ethernet:{{ pyh_ipv4_ethernet_addr }}; Access:{{ ansible_host }}"
      tags:
        - always


# ========================================================================

  roles:

    - role: ../roles/add-user
      tags:
        - setup-pi
        - always

    - role: ../roles/networking
#      when: install_networking|default(True)
      tags: 
#        - setup-network
#        - setup-pi
        - always

    - role: ../roles/hostname
      tags:
        - always

    - role: ../roles/avahi
      tags:
        - setup-pi
        - always

    - role: roles/package-management
      tags:
        - always

### END DBK
